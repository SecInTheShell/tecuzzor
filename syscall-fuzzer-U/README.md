# Introduction

**TODO**

## Why Rust

- Type check to guarantee one can make *correct* syscalls
- Macro system to alleviate coding burden

# Usage

Please make sure when you execute the fuzzer binary, there is a `./test1.txt` file under the same directory.

## Build

First, please install the `rustup` toolchain and get :
```sh
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

### Features

Currently, there is an optional features for binary generation: `type_only`. Once enabled, the semantics of the syscalls are then not enforced, meaning that the syscall can be generated not according to its semantics. For example, for a enum type, usually the fuzzer enforces the enum is valid. However, with `type_only` enabled, the validity of the enum is not guaranteed and it just obey the type prescribed in the syscall's function signature.

If you want to use this feature, please add `--features "type_only"` when building this project with `cargo`.

## Experiment

Just run `cargo run`.

## Release

In the root directory, run:
```sh
cargo build --release
```

Then the release binary can be found at `target/release`.

## Document

If you need to know the implementation details, please refer to the document, which can be generated by:

```sh
cargo doc --open
```

If you're using CLI, please go to `target/doc/syscall_fuzzer/index.html` to find the documents.

## Modify Source code

You can comment or uncomment the testing statements in the source code to customize the fuzzing process. Please check `src/[submodule_name]` to do so. Also please make sure the corresponding submodule enabled in `/src/main.rs`.

Besides, you can also modify `SEED` and `REPEAT` to control the fuzzing loop (see doc).

## Test

Unfortunately, tests are not finished at this time.

# Files

## `/analyzer`

**TODO**

A python script to analyze the log from `strace`, comparing the log from the fuzzer itself to find interesting findings.

## `/dec_macro`

Declarative macros of Rust to achieve custom derives.

## `/fuzzer_macro`

Procedural macros. Support `Named` and `Unit` types.

## `/src`

The upper layer interface for controlling which syscalls in each subsystem are fuzzed.

## `/fuzzer_types`

The syscall semantics and the data types used in the syscall

## `/ctests`

Some short test demos written in C.

# Roadmap

## Architecture

- [ ] Multi-threading 
- [ ] Linux device (`/dev`) support
- [ ] Configurable fuzzing
- [ ] A more decent memory allocation method
- [X] Support boxed pointers
- [ ] Handle *nonreturn* functions
- [ ] Spawn/Fork thread/process to test IPC calls

## Macros

### Procedural

#### `Generate` 

custom derive `generate()` for syscall functions ~~datatypes~~, which instantiate a syscall with arguments filled correctlyã€‚

- [ ] Sanitize the code

#### `Call`

custom derive `call()` to make syscall

- [] Support nested hidden elements

#### `Argument` 

custom derive `argumentize()` to extract the first element in a tuple struct

**Be sure to only use on tuple struct containing only one element**

### Declarative

- `testcall!` to perform a syscall, which takes a struct and a generator

## Datatype support

### Buffer
- [X] Buffer(`ArgBuffer`) with randomly filled data&size to pass to OS
- [X] Buffer(`RetBuffer`) of random size to accept return value from OS
- [X] Use marco to distinguish buffer type and add a length/count parameter automatically

**TODOs**

## Syscall Support

### File system

- [X] `open`
- [X] `close`
- [X] `read`
- [X] `write`
- [X] `stat`: See below
- [X] `fstat`: See below
- [X] `lstat`: 
- [X] `poll`
- [X] `lseek`
- [X] `pread64`
- [X] `pwrite64`
- [X] `writev`
- [X] `readv` 
- [X] `access`
- [X] `pipe`
- [X] `pipe2`
- [ ] `select`: Need a lot of work
- [ ] `fnctl`

### Network

Currently network semantics is not enforced, which means the syscalls are usually independent and can lead to error result.

Note that `send` and `recv` are *NOT* system call! They are implemented via the real syscall, `sendto` and `recvfrom`.

- [X] `socket`
- [X] `connect`
- [X] `send`
- [X] `sendto`
- [X] `recv`
- [X] `recvfrom`
- [X] `getsockopt`
- [X] `setsockopt`

### Memory Management

TODO: implement `Drop` for allocated memory

- [X] `mmap`
- [X] `munmap`
- [X] `mprotect`
- [X] `brk`
- [X] `mremap`
- [ ] `madvise`
- 

### Synchronization/IPC/Signal

- [ ] `rt_sigaction`: very difficult, unimplemented for now. function pointer for C?
- [X] `tt_sigprocmask`: ~~`EINVAL`?~~
- [ ] `rt_sigreturn `: need checks
- [ ] `futex`: Since futex is a very complex syscall, it can only guarantee the type is partially correct for now.


### Thread/Process Control

- [ ] `tgkill`
- [ ] `tkill`
- [ ] `exit`: can only be invoked once in a fuzzing loop
- [ ] `exit_group`: same as `exit`
- [ ] `vfork`: no return
- [X] `getuid`
- [X] `geteuid`
- [X] `gettid`
- [X] `getpid`
- [X] `getppid`
- [ ] `sched_yield`

### Time

- [X] `nanosleep`

### Auxillary



### Others

- [ ] `ioctl`

## MISC

- [ ] `In`/`Out` mark on arguments needed?

- [X] Random parameter generation


# Reference

- [Trinity](https://github.com/kernelslacker/trinity)
- [Syscall Importance](https://oscarlab.github.io/api-compat-study/data/linux-syscalls-api-importance.csv)
- [Syscall Importance Unweighted](https://oscarlab.github.io/api-compat-study/data/linux-syscalls-unweighted-api-importance.csv)

## Linux

- [syscall table](https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl)
- [Linux Test Project](https://github.com/linux-test-project/ltp): Examples of how to makes syscalls in C

## Rust Side

- [parser-combinators](https://bodil.lol/parser-combinators/)
- [Simple Parser in Rust](https://adriann.github.io/rust_parser.html)
- [Rust Lib C Document](https://docs.rs/libc/0.2.94/libc/)
- [Rust `syscalls` Lib](https://github.com/jasonwhite/syscalls/blob/master/src/nr.rs)

### Macros

- https://stackoverflow.com/questions/55271857/how-can-i-get-the-t-from-an-optiont-when-using-syn

## C Side

- [C Syntax](https://www2.cs.arizona.edu/~debray/Teaching/CSc453/DOCS/cminusminusspec.html)
- [syscalls.h](https://github.com/torvalds/linux/blob/master/include/linux/syscalls.h#L479)
- [syscalls](https://linuxhint.com/list_of_linux_syscalls)

